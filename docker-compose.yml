version: '3.8'

services:
  # Load balancer / API Gateway
  nginx-lb:
    image: nginx:alpine
    container_name: lighthouse-lb
    restart: unless-stopped
    ports:
      - "9001:80"
    volumes:
      - ./nginx-lb.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - queue-manager
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Queue Manager - handles job queue and dispatches to workers
  queue-manager:
    build:
      context: .
      dockerfile: Dockerfile.queue
    container_name: lighthouse-queue
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - WORKER_SERVICE=worker
      - WORKER_PORT=8080
    depends_on:
      - worker
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Lighthouse Workers - scale with: docker compose up -d --scale worker=N
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - CHROME_PATH=/usr/bin/google-chrome
    shm_size: 2gb
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_ADMIN
    deploy:
      replicas: 6  # Testing 6 workers - monitor CPU (~85%) and memory (~9GB)
      resources:
        limits:
          memory: 1.5G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
